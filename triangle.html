<!DOCTYPE html>
<!-- saved from url=(0052)http://webgl3d.info/ex/ch03_eg01_SingleTriangle.html -->
<html lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link rel="stylesheet" href="fileOther/stylesheet.css">
    <script src="fileOther/commonFunctions.js">
    </script>
    <script src="fileOther/gl-matrix-min.js">
    </script>
    <script src="fileOther/webglTools.js">
    </script>
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
        attribute vec4 aColor;
        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;
        varying vec4 vColor;
        varying vec2 vTexCoord;
        void main(void) {
          vColor = aColor;
          vTexCoord = (aVertexPosition.xy + 1.0) / 2.0;
          gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        }

    </script>
    <script id="shader-fs" type="x-shader/x-fragment">
        #ifdef GL_ES
          precision highp float;
        #endif
        varying vec4 vColor;
        uniform sampler2D uSampler;
        uniform int uSamplerBool;
        varying vec2 vTexCoord;
        void main(void) {
          if(uSamplerBool == 1)
          {
            gl_FragColor = texture2D(uSampler, vTexCoord);
          }
          else
          {
              gl_FragColor = vColor;
          }
        }

    </script>
    <script>
        var vertexBuffer = null;
        var indexBuffer = null;
        var colorBuffer = null;
        var indices = [];
        var vertices = [];
        var colors = [];
        //var vertexBuffer2 = null;
        var indexBuffer2 = null;
        //var colorBuffer2 = null;
        var indices2 = [];
        //var vertices2 = [];
        //var colors2 = [];
        var mvMatrix = mat4.create();
        var pMatrix = mat4.create();
        var rttFramebuffer;
        var rttTexture;

        function initTextureFramebuffer() {
            rttFramebuffer = glContext.createFramebuffer();
            glContext.bindFramebuffer(glContext.FRAMEBUFFER,rttFramebuffer);
            rttFramebuffer.width=512;
            rttFramebuffer.height=512;

            // espace pour la texture sur la cg (WEBTOOL textureWithImage)

            rttTexture = glContext.createTexture();
            glContext.bindTexture(glContext.TEXTURE_2D, rttTexture);
            glContext.texParameteri(glContext.TEXTURE_2D, glContext.TEXTURE_MAG_FILTER, glContext.LINEAR);
            glContext.texParameteri(glContext.TEXTURE_2D, glContext.TEXTURE_MIN_FILTER, glContext.LINEAR_MIPMAP_NEAREST);
            // glContext.generateMipmap(glContext.TEXTURE_2D);
            glContext.texImage2D(glContext.TEXTURE_2D, 0, glContext.RGBA, rttFramebuffer.width, rttFramebuffer.height, 0, glContext.RGBA, glContext.UNSIGNED_BYTE, null);

            // mtn on a préparer un espace pour la texture qui est vide et de taille du rttFramebuffer. contiendra pour les couleurs, le canevas.

            // on va  définir le buffer de rendu
            var renderbuffer = glContext.createRenderbuffer();
            glContext.bindRenderbuffer(glContext.RENDERBUFFER, renderbuffer);
            glContext.renderbufferStorage(glContext.RENDERBUFFER,glContext.DEPTH_COMPONENT16, rttFramebuffer.width, rttFramebuffer.height);

            /*
            * Nous attachons tout à la framebuffer actuelle (rappelez-vous, nous avons lié notre nouveau pour être le courant juste après sa création en haut de la fonction).
            * Nous lui disons que l'espace du framebuffer pour les couleurs de rendu ( gl.COLOR_ATTACHMENT0 ) est notre texture, et que la mémoire qu'il doit utiliser pour
            * obtenir des informations de profondeur ( gl.DEPTH_ATTACHMENT ) est le tampon de profondeur que nous venons de créer.
            * */
            glContext.framebufferTexture2D(glContext.FRAMEBUFFER, glContext.COLOR_ATTACHMENT0, glContext.TEXTURE_2D, rttTexture, 0);
            glContext.framebufferRenderbuffer(glContext.FRAMEBUFFER, glContext.DEPTH_ATTACHMENT, glContext.RENDERBUFFER, renderbuffer);

            /*
            * maintenant que tout est correctement créer est binder, on les remets a 0
            * */
            glContext.bindTexture(glContext.TEXTURE_2D, null);
            glContext.bindRenderbuffer(glContext.RENDERBUFFER, null);
            glContext.bindFramebuffer(glContext.FRAMEBUFFER, null);


        }

        function initShaderParameters(prg) {
            prg.vertexPositionAttribute = glContext.getAttribLocation(prg, "aVertexPosition");
            glContext.enableVertexAttribArray(prg.vertexPositionAttribute);
            prg.colorAttribute = glContext.getAttribLocation(prg, "aColor");
            glContext.enableVertexAttribArray(prg.colorAttribute);
            prg.pMatrixUniform = glContext.getUniformLocation(prg, 'uPMatrix');
            prg.mvMatrixUniform = glContext.getUniformLocation(prg, 'uMVMatrix');
            
            prg.samplerUniform = glContext.getUniformLocation(prg, "uSampler");
            prg.samplerBoolUniform = glContext.getUniformLocation(prg, "uSamplerBool");
        }
        function initBuffers() {

            // POS X Y Z
            vertices.push(-1.0, -1.0, 0.0);
            vertices.push(1.0, -1.0, 0.0);
            vertices.push(0.0, 1.0, 0.0);

            vertices.push(-1, 1.0, 0.0);
            vertices.push(1.0, 1.0, 0.0);
            vertices.push(0.0, -1.0, 0.0);
            
            vertices.push(-1.0, -1.0, 0.0);
            vertices.push(1.0, -0.5, 0.0);
            vertices.push(-1.0, 1.0, 0.0);
            vertices.push(1.0, 1.0, 0.0);


            // color R G B TRANSPARENCE
            colors.push(0.0, 0.0, 0.0, 1.0);
            colors.push(0.0, 0.0, 0.0, 1.0);
            colors.push(0.0, 0.0, 0.0, 1.0);
            
            colors.push(1.0, 1.0, 1.0, 1.0);
            colors.push(1.0, 1.0, 1.0, 1.0);
            colors.push(1.0, 1.0, 1.0, 1.0);
            
            colors.push(0.0, 1.0, 1.0, 1.0);
            colors.push(1.0, 0.0, 1.0, 1.0);
            colors.push(1.0, 1.0, 0.0, 1.0);
            colors.push(1.0, 1.0, 1.0, 1.0);

            indices.push(0, 1, 2);
            indices.push(3, 4, 5);
            
            indices2.push(6, 7, 8, 9);

            vertexBuffer = getVertexBufferWithVertices(vertices);
            colorBuffer = getVertexBufferWithVertices(colors);
            indexBuffer = getIndexBufferWithIndices(indices);
            indexBuffer2 = getIndexBufferWithIndices(indices2);

        }
        function drawScene() {
            // etablie le frameBUFFER
            glContext.bindFramebuffer(glContext.FRAMEBUFFER, rttFramebuffer);
            // mis en place du buffer frame
            
            glContext.viewport(0, 0, rttFramebuffer.width, rttFramebuffer.height);
            glContext.enable(glContext.DEPTH_TEST);
            glContext.clear(glContext.COLOR_BUFFER_BIT | glContext.DEPTH_BUFFER_BIT);
            mat4.identity(pMatrix);
            mat4.identity(mvMatrix);

            glContext.uniform1i(prg.samplerBoolUniform, 0);
            glContext.uniformMatrix4fv(prg.pMatrixUniform, false, pMatrix);
            glContext.uniformMatrix4fv(prg.mvMatrixUniform, false, mvMatrix);
            glContext.bindBuffer(glContext.ARRAY_BUFFER, vertexBuffer);
            glContext.vertexAttribPointer(prg.vertexPositionAttribute, 3, glContext.FLOAT, false, 0, 0);
            glContext.bindBuffer(glContext.ARRAY_BUFFER, colorBuffer);
            glContext.vertexAttribPointer(prg.colorAttribute, 4, glContext.FLOAT, false, 0, 0);
            glContext.bindBuffer(glContext.ELEMENT_ARRAY_BUFFER, indexBuffer);
            
            glContext.activeTexture(glContext.TEXTURE0);
            glContext.bindTexture(glContext.TEXTURE_2D, null);
            
            // type du graphique
            glContext.drawElements(glContext.TRIANGLES, indices.length, glContext.UNSIGNED_SHORT, 0);
            
            glContext.bindTexture(glContext.TEXTURE_2D, rttTexture);
            glContext.generateMipmap(glContext.TEXTURE_2D);
            glContext.bindTexture(glContext.TEXTURE_2D, null);

            glContext.bindFramebuffer(glContext.FRAMEBUFFER, null);
            
            glContext.viewport(0, 0, c_width, c_height);
            glContext.clear(glContext.COLOR_BUFFER_BIT | glContext.DEPTH_BUFFER_BIT);
            mat4.identity(pMatrix);
            mat4.identity(mvMatrix);
            
            glContext.bindBuffer(glContext.ELEMENT_ARRAY_BUFFER, indexBuffer2);
            glContext.uniform1i(prg.samplerBoolUniform, 1);

            glContext.activeTexture(glContext.TEXTURE0);
            glContext.bindTexture(glContext.TEXTURE_2D, rttTexture);
            glContext.uniform1i(prg.samplerUniform, 0);
            
            glContext.uniformMatrix4fv(prg.pMatrixUniform, false, pMatrix);
            glContext.uniformMatrix4fv(prg.mvMatrixUniform, false, mvMatrix);
            glContext.bindBuffer(glContext.ARRAY_BUFFER, vertexBuffer);
            glContext.vertexAttribPointer(prg.vertexPositionAttribute, 3, glContext.FLOAT, false, 0, 0);
            glContext.bindBuffer(glContext.ARRAY_BUFFER, colorBuffer);
            glContext.vertexAttribPointer(prg.colorAttribute, 4, glContext.FLOAT, false, 0, 0);

            glContext.drawElements(glContext.TRIANGLE_STRIP, indices2.length, glContext.UNSIGNED_SHORT, 0);
        }
        function initWebGL() {
            glContext = getGLContext('webgl-canvas');
            glContext.clearColor(0.9, 0.9, 0.9, 1.0);
            initProgram();
            initTextureFramebuffer();
            initBuffers();
            renderLoop();
        }
    </script>
    <title>Un simple triangle</title></head>
<body onload="initWebGL()">
<script>
</script>
<header>
    <h1>Un simple triangle<br></h1>
    <br>&nbsp;&nbsp;<a href="http://webgl3d.info/" style="text-decoration:none; color: white;">WebGL par la pratique©
    2015</a></header>
<br>
Un simple triangle.
<br>
<canvas id="webgl-canvas" width="500" height="500">
    HTML5 is not supported
</canvas>

</body>
</html>